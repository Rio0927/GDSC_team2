{% load timetable_extras %}

{% block content %}

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://code.jquery.com/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
<link href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" rel="stylesheet" />
</head>

<body>
    <div class="bg-white shadow-lg rounded px-8 pt-6 pb-8 mb-4 timetable-grade-and-semester">
        <h1 class="text-2xl font-bold my-4">学年・学期を選択</h1>
        <label for="grade">学年:</label>
        <select id="grade" name="grade"
            class="shadow appearance-none border rounded w-50 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
        </select>
        <label for="semester">学期:</label>
        <select id="semester" name="semester"
            class="shadow appearance-none border rounded w-50 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            <option value="1">前期</option>
            <option value="2">後期</option>
        </select>
    </div>
    <div id="grid-container" class="grid grid-cols-7 gap-3 p-5">
        <!-- JavaScriptによってここにカードが配置されます -->

    </div>



    <style>
        .drawer {
            height: 0;
            overflow: hidden;
            transition: height 0.5s;
            background-color: #f0f0f0;
            padding: 20px;
            position: fixed;
            /* 追加 */
            width: 100%;
            /* 追加 */
            bottom: 0;
            /* 追加 */

        }

        .drawer.open {
            height: 400px;
            overflow: auto;
        }
    </style>


    <script>
        function pushButton(day, period) {
            console.log(day);
            console.log(period);
            let grade = document.getElementById('grade').value;
            let semester = document.getElementById('semester').value;
            console.log(semester);
            $.ajax({
                url: "{% url 'show_courses' %}",
                type: "POST",
                data: {
                    grade: document.getElementById('grade').value,
                    semester: document.getElementById('semester').value,
                    day: day,
                    period: period,
                    csrfmiddlewaretoken: "{{ csrf_token }}"
                },
                dataType: 'json',
                success: function (data) {
                    const drawer = document.querySelector('.drawer');

                    if (data.status == "success") {
                        console.log(data.courses);
                        drawer.innerHTML = `<button class="block text-2xl py-4 " onclick="closeDrawer();">×</button>`;
                        if (data.courses.length > 0) {
                            data.courses.forEach(element => {
                                drawer.innerHTML += `
                                    <input type="radio" 
                                    id = "course-${element["id"]}"
                                    name="courses" 
                                    value="${element["id"]}" 
                                    class="leading-4 ">
                                <label for="course-${element["id"]}">${element["course_name"]}-(${element["course_prof"]})-${element["classroom"]}</label>
                                    
                                    <br>
                                `
                            });
                            drawer.innerHTML += `<br><button onclick="registerCourse(checkedCourse(),${grade},${semester})"
                            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">登録する</button>`;

                        } else {
                            drawer.innerHTML += "受講できる科目がありません<br>";
                        }

                    }



                }
            });
        }

        function checkedCourse() {
            let elems = document.getElementsByName("courses");
            for (let i = 0; i < elems.length; i++) {
                // i番目のラジオボタンがチェックされているかを判定
                if (elems[i].checked) {
                    console.log(elems[i].value);
                    return elems[i].value;
                }
            }
        }

        function registerCourse(courseId, grade, semester) {
            console.log(courseId, grade, semester);
            $.ajax({
                url: "{% url 'register_timetable' %}",
                type: "POST",
                data: {
                    course_id: courseId,
                    grade: grade,
                    semester: semester,
                    csrfmiddlewaretoken: "{{ csrf_token }}"
                },
                dataType: 'json',
                success: function (data) {
                    if (data.status == "success") {
                        toastr.success(data.message);
                        console.log(data.message);
                    } else if (data.status == "error") {
                        toastr.error(data.message);
                        console.log(data.message);

                    } else {
                        toastr.warning(data.message);
                        console.log(data.message);

                    }
                }
            });
            displayTimetable()
        }

        function closeDrawer() {
            const drawer = document.querySelector('.drawer');
            drawer.classList.remove('open');
        }

        function displayTimetable() {
            let grade = document.getElementById('grade').value;
            let semester = document.getElementById('semester').value;
            const drawer = document.createElement('div');
            drawer.className = 'drawer rounded-3xl';
            document.body.appendChild(drawer);
            $.ajax({
                url: "{% url 'display_timetable' %}",
                type: "POST",
                data: {
                    grade: grade,
                    semester: semester,
                    csrfmiddlewaretoken: "{{ csrf_token }}"
                },
                dataType: 'json',
                success: function (data) {
                    if (data.status == "success") {
                        const container = document.getElementById('grid-container');
                        container.innerHTML = "";
                        let days = ["", "月", "火", "水", "木", "金", "土"];
                        let periods = ["", "1", "2", "3", "4", "5", "6"];
                        let colorClass = {
                            "情報基盤": "bg-blue-200",
                            "情報法": "bg-yellow-200",
                            "関連科目": "bg-green-200",
                            "演習科目": "bg-red-200",
                            "グローバル": "bg-purple-200",
                            "教養": "bg-orange-200",
                            "他学部履修科目": "bg-pink-200",
                            " ":"bg-gray-200"
                        }


                        for (let period of periods) {
                            for (let day of days) {
                                const card = document.createElement('button');
                                
                                if (period == "") {
                                    card.className = 'card bg-white text-2xl p-2 py-12 text-center';
                                    card.textContent = day;

                                } else if (day == "") {
                                    card.textContent = period;
                                    card.className = 'card bg-white text-2xl p-2 py-12 text-center';
                                } else {
                                    let courseName = data.courses[`${day}${period}`]["name"];
                                    let classroom = data.courses[`${day}${period}`]["classroom"];
                                    let professor = data.courses[`${day}${period}`]["prof"][0];
                                    let genre = data.courses[`${day}${period}`]["genre"];
                                    console.log(courseName, genre);
                                    let color = colorClass[genre];
                                    card.className = `card p-2 py-12 text-center ${color}`;
                                    card.innerHTML = `${courseName} <br> ${classroom} <br> ${professor}`
                                    card.setAttribute('onclick', `pushButton("${day}", "${period}")`);
                                    card.addEventListener('click', function () {
                                        const drawer = document.querySelector('.drawer');
                                        if (!drawer.classList.contains('open')) {
                                            drawer.classList.add('open');
                                        }
                                    });
                                }


                                container.appendChild(card);

                            }
                        }

                    }
                }
            });

        }

        window.onload = displayTimetable();

        let gradeElement = document.querySelector("#grade");
        let semesterElement = document.querySelector("#semester");
        gradeElement.addEventListener("change", (event) => {
            displayTimetable();
        });
        semesterElement.addEventListener("change", (event) => {
            displayTimetable();
        });



    </script>
</body>

</html>








<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

{% endblock %}